---
layout: default
title: เมื่อ Elastic Load Balancing พังความชิบหายก็มาเยือน
---

# มันคืออะไร

Elastic Load Balancing ทำหน้าที่รองรับ traffic จากภายนอกไปยัง Amazon EC2 instance ทำให้สามารถทำการกระจายระบบแบบแนวนอน (horizontal scaling) ได้อย่างง่ายๆ เพียงแค่กดเพิ่มจำนวนของ instance แล้วที่เหลือก็ปล่อยให้เป็นหน้าที่ของ load balancer

# ใช้แล้วดีอย่างไร

* Availability อย่างที่บอกไปว่ามันช่วยให้เพิ่มการรองรับ traffic ปริมาณมากจากภายนอกก่อนกระจายการทำงานให้ instance ที่อยู่ภายใน

* Elasticity มันยืดหยุ่นเพราะสามารถขยายออกและเข้าได้ตามปริมาณจริง มาเยอะก็ขยายออกเยอะ ถ้าลดลงก็หดตัวได้เองตามที่เราตั้งค่าไว้

* Security การเชื่อมต่อภายในจะเป็น private network ทั้งหมด การใช้งานจากภายนอกอาจจะไม่รู้ด้วยซ้ำว่ามี private network ตัวนี้ค่อยกระจายการทำงานอยู่ นอกจากนี้ยังรอบรับการทำ ssl/tls ให้ web service ด้วย

# แล้ววันนี้เกิดอะไรขึ้น

ปัญหาวันนี้เกิดขึ้นเมื่อมีปริมาณการใช้เกินกว่าค่าหนึ่งมันแทนที่มันควรจะเพิ่ม instance ให้ระบบเพื่อรองรับการใช้งาน แต่มันไม่ยอมขยายและยังไม่ยอม forward package ไปหา instance ซะด้วย (ก่อนที่บริการจะ down ไป latency time เริ่มสูงขึ้นเรื่อยๆ จน timeout) แบบนี้ก็งานเข้าสิครับแถมเป็นช่วงที่การใช้งานพุ่งเป็น spike เลยต้องหาวิธีการแก้ปัญหาให้เร็วที่สุด

เนื่องจากการย้ายกลับมาที่ local server ที่เป็น physical จำเป็นต้องรอให้ dns update ทั้งหมดซึ่งไม่ทันการแน่ๆ และการใช้ Elastic Beanstalk นั้นผูกกับ cname อีกเราเลยต้องหาทางแก้ปัญหาในระบบ AWS เท่านั้น (Beanstalk คือ application as a service ที่เรียก instance ว่า environment)

# แล้วผมแก้อย่างไร

เมื่อเกิดปัญหาก็ต้องหาคนแก้ แน่นอนว่าต้องมองหา technical support อยู่แล้ว แต่ด้วยความขี้งกทำระบบเลย deploy บน Amazon free-tier ซึ่งไม่รวม technical support อีก ผมนี้ถึงกับยืนขึ้นเลยครับ

หลังจากลุกไปเข้าห้องน้ำและแวะเติมน้ำกลั่น (ดื่มน้ำ) ผมก็นึกถึงว่าใน Elastic Beanstalk นั้นมีคุณสมบัติในการ swap environment ได้นินา เหมือนยกภูเขาออกจากอกเลย แค่สร้าง environment ใหม่แล้วทำการ swap เข้ากับ cname เดิมที่ผูกไว้ แค่นี้ระบบก็กลับมา back to online แล้ว

# เรื่องนี้สอนอะไรบ้าง

- ถึงจะเป็น cloud ก็ต้องหาแผนสำรองไว้เสมอ และต้องตระหนักว่าแผนสำรองมันใช้ได้ทันทีหรือไม่ อย่างแผนสำรองผมคือ migrate กลับมาที่ local server แต่ก็ทำไม่ได้เพราะข้อจำกัดของ dns
- การจะฝากชีวิตของงานเราไว้กับบริการใดๆ กรุณาศึกษาช่องทางการติดต่อ support ไว้ล่วงหน้า กรณีนี้ผมไม่เคยรู้มาก่อนเลยว่าของฟรีต้องช่วยตัวเองเท่านั้น
- เลิกงก ในบางบริการเราอาจจะมองว่าแพง แต่ให้ลองดูดีๆ ว่าราคานั้นคือรวมบริการ support ไว้แล้วหรือไม่ ยิ่งถ้าแพงแล้วไม่มี support ก็ไม่ค่อยน่าคบนะ
